<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wire Request Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MSAL Library - Alternative CDN (more reliable) -->
    <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.26.0/dist/msal-browser.umd.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; }
    </style>
</head>
<body>
    <div id="app">
        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #1f2937 0%, #111827 100%);">
            <div style="text-align: center; color: white;">
                <div style="width: 50px; height: 50px; border: 4px solid #3b82f6; border-top-color: white; border-radius: 50%; margin: 0 auto 20px; animation: spin 1s linear infinite;"></div>
                <p style="font-size: 18px; font-weight: 500;">Initializing Wire Request Portal...</p>
                <p style="font-size: 12px; color: #9ca3af; margin-top: 10px;">Connecting to Azure AD...</p>
            </div>
        </div>
        <style>
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        </style>
    </div>

    <script>
        console.log('=== Wire Request Portal - Azure AD Edition ===');
        console.log('Script loaded, waiting for MSAL...');
        console.log('Current URL:', window.location.origin);
        
        // CONFIGURATION
        const msalConfig = {
            auth: {
                clientId: "8a44d772-bd32-49a0-a570-7d1f4749a308",
                authority: "https://login.microsoftonline.com/common",
                redirectUri: window.location.origin + "/",
                postLogoutRedirectUri: window.location.origin + "/"
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            },
            system: {
                allowNativeBroker: false
            }
        };

        const loginRequest = {
            scopes: ["User.Read", "profile", "openid", "email"]
        };

        let msalInstance = null;
        let appInitialized = false;

        // WAIT FOR MSAL LIBRARY TO LOAD
        const waitForMSAL = new Promise((resolve, reject) => {
            let attempts = 0;
            const maxAttempts = 30;

            const checkMSAL = () => {
                if (typeof msal !== 'undefined' && (msal.PublicClientApplication || msal.default?.PublicClientApplication)) {
                    console.log('‚úì MSAL Library loaded');
                    resolve();
                } else if (attempts < maxAttempts) {
                    attempts++;
                    setTimeout(checkMSAL, 500);
                } else {
                    console.error('MSAL library failed to load after', attempts * 0.5, 'seconds');
                    reject(new Error('MSAL library did not load. Check your internet connection.'));
                }
            };

            checkMSAL();
        });

        // APP STATE
        const app = {
            currentUser: null,
            userEmail: null,
            userRole: null,
            showForm: false,
            formData: {
                requestor: '',
                email: '',
                property: '',
                amount: '',
                purpose: '',
                wireDate: '',
                urgency: 'Standard (3-5 days)',
            },
            requests: [
                { id: 'WR-2025-0001', requestor: 'Sarah Johnson', property: 'Hickory Point', amount: 125000, purpose: 'Operation Funding', status: 'Completed', managerApproved: true, financeApproved: true, date: '2025-02-10' },
                { id: 'WR-2025-0002', requestor: 'Mike Chen', property: 'Lee\'s Landing', amount: 45000, purpose: 'Capex Draw Funding', status: 'Manager Approved', managerApproved: true, financeApproved: false, date: '2025-02-14' },
            ],
            properties: ['Hickory Point', 'Lee\'s Landing', 'Hilton Village', 'Blue Ridge', 'Broad on the Green', 'Lake Village', 'Madison Woods'],
            purposes: ['Operation Funding', 'Capex Draw Funding'],
        };

        const roleMapping = {
            'afaircloth@ritzbanc.com': 'manager',
            'welhage@ritzbanc.com': 'finance',
        };

        // INITIALIZE MSAL
        const initializeMSAL = async () => {
            try {
                console.log('Initializing MSAL with Azure AD...');
                
                // Handle different MSAL library structures
                const PublicClientApplication = msal.PublicClientApplication || msal.default?.PublicClientApplication;
                
                if (!PublicClientApplication) {
                    throw new Error('PublicClientApplication not found in MSAL library');
                }
                
                msalInstance = new PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                
                console.log('‚úì MSAL initialized');

                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    const account = accounts[0];
                    app.currentUser = account.name;
                    app.userEmail = account.username;
                    app.userRole = roleMapping[app.userEmail?.toLowerCase()] || 'requester';
                    app.formData.requestor = app.currentUser;
                    app.formData.email = app.userEmail;
                    console.log('User session found:', account.username);
                }

                appInitialized = true;
                render();
                
            } catch (error) {
                console.error('MSAL init error:', error);
                showError('Failed to initialize Azure AD authentication', error);
            }
        };

        const showError = (title, error) => {
            console.error('DETAILED ERROR:', {
                title,
                message: error?.message,
                stack: error?.stack,
                msalLoaded: typeof msal !== 'undefined',
                msalType: typeof msal,
                navigatorOnline: navigator.onLine
            });
            
            document.getElementById('app').innerHTML = `
                <div style="min-height: 100vh; background: #1f2937; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 500px;">
                        <h2 style="color: #dc2626; margin: 0 0 15px 0; font-size: 20px; font-weight: bold;">‚ö†Ô∏è ${title}</h2>
                        <div style="background: #fee2e2; border: 1px solid #fca5a5; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <p style="color: #991b1b; font-size: 12px; margin: 0; font-family: monospace; word-break: break-all;">${error?.message || error}</p>
                        </div>
                        <p style="color: #666; font-size: 13px; margin: 0 0 15px 0;">
                            <strong>Troubleshooting:</strong>
                        </p>
                        <ul style="color: #666; font-size: 13px; margin: 0 0 20px 0; padding-left: 20px;">
                            <li>Check your internet connection</li>
                            <li>Try hard refresh: Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)</li>
                            <li>Try a different browser</li>
                            <li>Check Azure AD Redirect URI matches your Vercel URL</li>
                        </ul>
                        <button onclick="location.reload()" style="width: 100%; background: #3b82f6; color: white; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                </div>
            `;
        };

        // LOGIN
        const handleLogin = async () => {
            if (!msalInstance) {
                alert('System not ready. Please refresh.');
                return;
            }

            try {
                const response = await msalInstance.loginPopup(loginRequest);
                
                if (response && response.account) {
                    app.currentUser = response.account.name;
                    app.userEmail = response.account.username;
                    app.userRole = roleMapping[app.userEmail?.toLowerCase()] || 'requester';
                    app.formData.requestor = app.currentUser;
                    app.formData.email = app.userEmail;
                    
                    console.log('‚úì Login successful:', app.userEmail, 'Role:', app.userRole);
                    render();
                }
            } catch (error) {
                if (error.errorCode !== 'user_cancelled') {
                    console.error('Login error:', error);
                    alert('Login failed: ' + error.message);
                }
            }
        };

        // LOGOUT
        const handleLogout = async () => {
            try {
                if (msalInstance) {
                    await msalInstance.logout();
                }
                app.currentUser = null;
                app.userEmail = null;
                app.userRole = null;
                app.showForm = false;
                app.formData = { requestor: '', email: '', property: '', amount: '', purpose: '', wireDate: '', urgency: 'Standard (3-5 days)' };
                render();
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        // FORM SUBMIT
        const handleSubmit = (e) => {
            e.preventDefault();
            if (!app.formData.property || !app.formData.amount || !app.formData.purpose) {
                alert('Please fill all required fields');
                return;
            }

            const newRequest = {
                id: `WR-2025-${String(app.requests.length + 1).padStart(4, '0')}`,
                requestor: app.formData.requestor,
                property: app.formData.property,
                amount: parseFloat(app.formData.amount),
                purpose: app.formData.purpose,
                status: 'Pending',
                managerApproved: false,
                financeApproved: false,
                date: new Date().toISOString().split('T')[0],
            };

            app.requests.push(newRequest);
            app.showForm = false;
            app.formData = { requestor: app.currentUser, email: app.userEmail, property: '', amount: '', purpose: '', wireDate: '', urgency: 'Standard (3-5 days)' };

            alert(`‚úì Request ${newRequest.id} submitted!\n\nEmail sent to Anthony Faircloth`);
            render();
        };

        const handleApprove = (id) => {
            const req = app.requests.find(r => r.id === id);
            if (!req) return;

            if (app.userRole === 'manager') {
                req.managerApproved = true;
                req.status = 'Manager Approved';
                alert('Approved! Forwarded to Wissam El Hage');
            } else if (app.userRole === 'finance') {
                req.financeApproved = true;
                req.status = 'Completed';
                alert('Request completed!');
            }
            render();
        };

        const handleReject = (id) => {
            const reason = prompt('Rejection reason:');
            if (reason) {
                const req = app.requests.find(r => r.id === id);
                if (req) {
                    req.status = 'Rejected';
                    alert('Request rejected');
                    render();
                }
            }
        };

        // RENDER LOGIN
        const renderLogin = () => `
            <div style="min-height: 100vh; background: linear-gradient(135deg, #1f2937 0%, #111827 100%); display: flex; align-items: center; justify-content: center; padding: 20px;">
                <div style="background: white; padding: 40px; border-radius: 15px; max-width: 400px; text-align: center;">
                    <h1 style="color: #1f2937; font-size: 28px; font-weight: bold; margin-bottom: 10px;">Wire Request Portal</h1>
                    <p style="color: #666; margin-bottom: 30px;">Real Estate Asset Management</p>
                    
                    <button onclick="handleLogin()" style="width: 100%; background: #2563eb; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin-bottom: 20px;">
                        üîê Login with Office 365
                    </button>
                    
                    <div style="padding: 15px; background: #eff6ff; border-left: 4px solid #3b82f6; text-align: left; border-radius: 6px;">
                        <p style="color: #1e40af; font-weight: bold; margin: 0 0 8px 0;">‚úì Azure AD Connected</p>
                        <p style="color: #1e3a8a; font-size: 13px; margin: 0;">Sign in with your Ritz Banc email</p>
                    </div>
                </div>
            </div>
        `;

        // RENDER REQUESTER
        const renderRequester = () => {
            const userRequests = app.requests.filter(r => r.requestor === app.currentUser);
            return `
                <div style="min-height: 100vh; background: linear-gradient(to right, #f3f4f6, #e5e7eb);">
                    <div style="background: white; border-bottom: 1px solid #e5e7eb; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 style="margin: 0; font-size: 24px; font-weight: bold; color: #1f2937;">Wire Request Portal</h1>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Submit and track requests</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0; font-weight: bold; color: #1f2937;">${app.currentUser}</p>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">${app.userEmail}</p>
                            <button onclick="handleLogout()" style="margin-top: 10px; background: #e5e7eb; color: #1f2937; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">Logout</button>
                        </div>
                    </div>
                    <div style="max-width: 1200px; margin: 0 auto; padding: 30px 20px;">
                        ${!app.showForm ? `<button onclick="app.showForm = true; render()" style="background: #2563eb; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 20px;">‚ûï Submit Wire Request</button>` : `
                            <div style="background: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;">
                                <h2 style="margin: 0 0 20px 0; color: #1f2937; font-size: 20px; font-weight: bold;">New Wire Request</h2>
                                <form onsubmit="handleSubmit(event)" style="display: grid; gap: 15px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1f2937;">Property *</label>
                                            <select onchange="app.formData.property = this.value" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                                <option value="">Select property...</option>
                                                ${app.properties.map(p => `<option value="${p}">${p}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1f2937;">Amount (USD) *</label>
                                            <input type="number" onchange="app.formData.amount = this.value" placeholder="0.00" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1f2937;">Type *</label>
                                            <select onchange="app.formData.purpose = this.value" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                                <option value="">Select type...</option>
                                                ${app.purposes.map(p => `<option value="${p}">${p}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #1f2937;">Wire Date</label>
                                            <input type="date" onchange="app.formData.wireDate = this.value" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button type="submit" style="flex: 1; background: #2563eb; color: white; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Submit</button>
                                        <button type="button" onclick="app.showForm = false; render()" style="flex: 1; background: #d1d5db; color: #1f2937; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        `}
                        <div style="background: white; border-radius: 12px; overflow: hidden;">
                            <div style="background: #f3f4f6; padding: 15px 20px; border-bottom: 1px solid #e5e7eb;">
                                <h3 style="margin: 0; color: #1f2937; font-weight: bold;">My Requests</h3>
                            </div>
                            <div>
                                ${userRequests.length === 0 ? `<div style="padding: 30px; text-align: center; color: #666;">No requests yet</div>` : userRequests.map(req => `
                                    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                                        <div style="display: flex; justify-content: space-between; align-items: start;">
                                            <div>
                                                <p style="margin: 0; font-weight: bold; color: #1f2937;">${req.id}</p>
                                                <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">${req.property}</p>
                                            </div>
                                            <span style="background: ${req.status === 'Completed' ? '#dcfce7' : req.status === 'Manager Approved' ? '#dbeafe' : '#fef3c7'}; color: ${req.status === 'Completed' ? '#166534' : req.status === 'Manager Approved' ? '#1e40af' : '#92400e'}; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">${req.status}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // RENDER APPROVER
        const renderApprover = () => {
            const pending = app.userRole === 'manager' 
                ? app.requests.filter(r => !r.managerApproved)
                : app.requests.filter(r => r.managerApproved && !r.financeApproved);

            return `
                <div style="min-height: 100vh; background: linear-gradient(to right, #f3f4f6, #e5e7eb);">
                    <div style="background: white; border-bottom: 1px solid #e5e7eb; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 style="margin: 0; font-size: 24px; font-weight: bold; color: #1f2937;">Approval Dashboard</h1>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">${app.userRole === 'manager' ? 'Level 1: Anthony Faircloth' : 'Level 2: Wissam El Hage'}</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0; font-weight: bold; color: #1f2937;">${app.currentUser}</p>
                            <button onclick="handleLogout()" style="margin-top: 10px; background: #e5e7eb; color: #1f2937; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">Logout</button>
                        </div>
                    </div>
                    <div style="max-width: 1200px; margin: 0 auto; padding: 30px 20px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #fbbf24;">
                                <p style="color: #666; margin: 0 0 10px 0;">Pending</p>
                                <p style="margin: 0; font-size: 32px; font-weight: bold; color: #1f2937;">${pending.length}</p>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #34d399;">
                                <p style="color: #666; margin: 0 0 10px 0;">Approved</p>
                                <p style="margin: 0; font-size: 32px; font-weight: bold; color: #1f2937;">${app.requests.filter(r => r.status === 'Completed').length}</p>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 12px; border-left: 4px solid #60a5fa;">
                                <p style="color: #666; margin: 0 0 10px 0;">Total</p>
                                <p style="margin: 0; font-size: 32px; font-weight: bold; color: #1f2937;">$${pending.reduce((s, r) => s + r.amount, 0).toLocaleString()}</p>
                            </div>
                        </div>
                        <div style="background: white; border-radius: 12px; overflow: hidden;">
                            <div style="background: #f3f4f6; padding: 15px 20px; border-bottom: 1px solid #e5e7eb;">
                                <h3 style="margin: 0; color: #1f2937; font-weight: bold;">Requests Awaiting Your Approval</h3>
                            </div>
                            <div>
                                ${pending.length === 0 ? `<div style="padding: 30px; text-align: center; color: #666;">All caught up! ‚úì</div>` : pending.map(req => `
                                    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                                        <p style="margin: 0 0 5px 0; font-weight: bold; color: #1f2937; font-size: 16px;">${req.id}</p>
                                        <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">${req.requestor} ‚Ä¢ ${req.property} ‚Ä¢ $${req.amount.toLocaleString()}</p>
                                        <div style="display: flex; gap: 10px;">
                                            <button onclick="handleApprove('${req.id}')" style="flex: 1; background: #22c55e; color: white; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">‚úì Approve</button>
                                            <button onclick="handleReject('${req.id}')" style="flex: 1; background: #ef4444; color: white; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">‚úï Reject</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const render = () => {
            if (!appInitialized) return;
            const appDiv = document.getElementById('app');
            
            if (!app.currentUser) {
                appDiv.innerHTML = renderLogin();
            } else if (app.userRole === 'requester') {
                appDiv.innerHTML = renderRequester();
            } else {
                appDiv.innerHTML = renderApprover();
            }
        };

        // GLOBAL FUNCTIONS
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;
        window.handleSubmit = handleSubmit;
        window.handleApprove = handleApprove;
        window.handleReject = handleReject;

        // START
        waitForMSAL.then(() => initializeMSAL()).catch(error => showError('Azure AD Initialization Failed', error));
    </script>
</body>
</html>
